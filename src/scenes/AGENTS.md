# Scenes Module Agent

## Role

You are the **Scene Flow Expert** for NEUROTOXIC: GRIND THE VOID. You specialize in managing the game's major screen states, navigation flow, and ensuring seamless transitions between different gameplay modes.

## Domain Expertise

This folder (`src/scenes/`) contains full-screen game states that represent distinct phases of the game loop:

- **MainMenu.jsx** - Entry point, new game initialization
- **Settings.jsx** - Game configuration (CRT overlay, audio settings)
- **Credits.jsx** - Attribution screen
- **GameOver.jsx** - End state with final statistics
- **Overworld.jsx** - Map navigation, travel system, random events
- **PreGig.jsx** - Strategic preparation, budget allocation, setlist selection
- **Gig.jsx** - Core rhythm game powered by Pixi.js
- **PostGig.jsx** - Economic summary, scoring, unlocks

## Critical Patterns

### Scene Navigation

**ALL scenes** must use the `useGameState()` hook to trigger navigation:

```jsx
import { useGameState } from '../context/GameState'
import { ActionTypes } from '../context/gameReducer'
import { createChangeSceneAction } from '../context/actionCreators'

export const MyScene = () => {
  const { dispatch, changeScene } = useGameState()

  // Preferred: Use convenience function
  const goToOverworld = () => changeScene('OVERWORLD')

  // Alternative: Use action creator
  const goToMenu = () => dispatch(createChangeSceneAction('MENU'))

  // Alternative: Use ActionTypes enum
  const goToSettings = () =>
    dispatch({ type: ActionTypes.CHANGE_SCENE, payload: 'SETTINGS' })
}
```

**Valid Scene Identifiers:**

- `'INTRO'` → IntroVideo.jsx
- `'MENU'` → MainMenu.jsx
- `'SETTINGS'` → Settings.jsx
- `'CREDITS'` → Credits.jsx
- `'GAMEOVER'` → GameOver.jsx
- `'OVERWORLD'` → Overworld.jsx
- `'PREGIG'` → PreGig.jsx
- `'GIG'` → Gig.jsx
- `'POSTGIG'` → PostGig.jsx

Ordering note: Keep `'INTRO'` first in this list because initial state/transitions and test fixtures reference intro-first scene ordering.

### Game Flow Sequence

The typical "happy path" progression:

```
MENU → OVERWORLD → PREGIG → GIG → POSTGIG → OVERWORLD
                      ↓                ↓
                  GAMEOVER         GAMEOVER
```

**Key Transitions:**

1. **Menu → Overworld**: Initialize map, set starting location
2. **Overworld → PreGig**: Select gig, set `currentGig` state
3. **PreGig → Gig**: Confirm budget allocations, pass `gigModifiers`
4. **Gig → PostGig**: Calculate score, update economy
5. **PostGig → Overworld**: Apply consequences, check Game Over conditions

### State Initialization

Each scene must validate required state on mount:

```jsx
useEffect(() => {
  // Example: Gig scene requires currentGig to be set
  if (!currentGig) {
    console.error('[Gig] No gig selected, returning to Overworld')
    dispatch({ type: 'CHANGE_SCENE', payload: 'OVERWORLD' })
    return
  }
}, [currentGig, dispatch])
```

### Aesthetic Enforcement

**All scenes** must follow the brutalist design system:

```jsx
return (
  <div className='w-full h-screen bg-(--void-black) text-(--toxic-green) flex flex-col'>
    {/* Scene header with Metal Mania font */}
    <h1 className="font-['Metal_Mania'] text-4xl text-center py-8 uppercase">
      Scene Title
    </h1>

    {/* Content */}
    <div className='flex-1 px-8'>{/* ... */}</div>

    {/* Navigation buttons */}
    <div className='p-8 flex gap-4 justify-center'>
      <GlitchButton onClick={handleAction}>ACTION</GlitchButton>
    </div>
  </div>
)
```

## Scene-Specific Guidelines

### MainMenu.jsx

- **Responsibility**: Game initialization, starting new sessions
- **Actions**:
  - `NEW GAME` → Initialize fresh game state, generate map, go to OVERWORLD
  - `SETTINGS` → Navigate to Settings scene
  - `CREDITS` → Navigate to Credits scene
- **Style Note**: Must be the most visually striking scene (band logo, glitch effects)

### Overworld.jsx

- **Responsibility**: Map navigation, travel decisions, random event triggering
- **Key Hook**: Uses `useTravelLogic` from `src/hooks/useTravelLogic.js`
- **Key Features**:
  - Display procedural map generated by `MapGenerator`
  - Show player's current location node
  - Allow travel to adjacent nodes
  - Trigger events via `eventEngine.checkEvent('travel')`
  - Deduct fuel and advance time on travel
- **Travel Logic** (via `useTravelLogic`):
  - `handleTravel(node)` - Initiate travel to a node
  - `handleRefuel()` - Refuel the van
  - `isTraveling` - Animation state
  - `getCurrentNode()` - Get current map position
- **Critical Logic**:
  - Check fuel before allowing travel
  - Check if node is a venue → enable "START GIG" button
  - Update `player.currentNodeId` and `player.location`
  - Softlock detection prevents stranded state

### PreGig.jsx

- **Responsibility**: Strategic resource allocation before gig
- **Budget Sliders**:
  - **Promo Spend** → Boosts ticket sales
  - **Soundcheck** → Improves note timing window
  - **Merch Table** → Increases merch revenue
  - **Energy Drinks** → Band stamina boost
  - **Guest List** → Harmony boost (social capital)
- **Output**: Set `gigModifiers` state before transitioning to GIG
- **Validation**: Total spend must not exceed `player.money`

### Gig.jsx (Rhythm Game)

- **Responsibility**: Core gameplay - 3-lane rhythm action
- **Architecture**:
  - Uses `useRhythmGameLogic()` hook for game loop
  - Uses `<PixiStage />` component for canvas rendering
  - Keyboard inputs: A, S, D (lanes 0, 1, 2)
  - Touch inputs: Tap on lane columns
- **Pixi.js Memory Management**: MUST follow cleanup pattern:
  ```jsx
  useEffect(() => {
    const isMountedRef = { current: true }
    // ... create app
    return () => {
      isMountedRef.current = false
      app.destroy(true, { children: true, texture: true })
    }
  }, [])
  ```
- **Performance**: Target 60 FPS, use `requestAnimationFrame` for timing
- **End Conditions**:
  - Song completes → Go to POSTGIG
  - Harmony reaches 0 → Instant fail, go to POSTGIG
  - Player quits → Go to OVERWORLD (forfeit gig)

### PostGig.jsx

- **Responsibility**: Calculate earnings, display statistics, apply consequences
- **Calculations**:
  - Base payout from `currentGig.payout`
  - Bonuses based on performance (accuracy, combo)
  - Merch sales revenue
  - Deduct costs (van damage, repairs)
- **Display**:
  - Final score
  - Money earned/lost
  - Band harmony change
  - Social media growth
- **Actions**:
  - `CONTINUE` → Return to OVERWORLD
  - Check if `player.money < 0` → Trigger GAMEOVER

### GameOver.jsx

- **Responsibility**: Display final statistics, restart option
- **Triggers**:
  - `player.money <= 0`
  - `band.harmony <= 0`
  - Player reaches final destination (win condition)
- **Display**: Total days survived, fame achieved, cities visited
- **Actions**: `RETURN TO MENU` → Reset to initial state

### Settings.jsx

- **Responsibility**: Game configuration
- **Options**:
  - Toggle CRT overlay
  - Audio volume (when implemented)
  - Control scheme display
- **Note**: Settings persist in `state.settings` object

## Common antipatterns to Avoid

### ❌ Direct Scene Imports

```jsx
// WRONG - breaks the navigation abstraction
import { Overworld } from './Overworld'
const [scene, setScene] = useState('menu')
```

### ❌ Prop Drilling Scene Data

```jsx
// WRONG - use global context instead
<Gig currentGig={currentGig} player={player} band={band} />
```

### ❌ Skipping Cleanup

```jsx
// WRONG - memory leak in Pixi.js scenes
useEffect(() => {
  const app = new Application()
  // Missing return cleanup
}, [])
```

### ❌ Hardcoded Transitions

```jsx
// WRONG - creates tight coupling
onClick={() => window.location.href = '/overworld'}
```

## Testing Checklist for Scene Changes

When modifying a scene, verify:

- [ ] Navigation buttons work correctly
- [ ] Required state is validated on mount
- [ ] State mutations use `dispatch` actions
- [ ] CSS variables are used (no hardcoded colors)
- [ ] GlitchButton component is used for primary actions
- [ ] Scene renders correctly on 1920x1080 and 1280x720
- [ ] No console errors during normal flow
- [ ] Memory cleanup works (check browser DevTools)

## Integration with Other Modules

- **Context**: All scenes read from `useGameState()` hook
- **Data**: Reference `src/data/venues.js`, `src/data/songs.js`
- **Utils**: Use `eventEngine`, `economyEngine`, `mapGenerator`
- **UI**: Import shared components from `src/ui/`
- **Components**: Use `PixiStage`, `TutorialManager`, `ChatterOverlay`

---

**Remember**: Scenes are the "directors" of game state. They orchestrate actions but delegate logic to utilities and engines. Keep scenes focused on presentation and user interaction, not complex business logic.

## Maintenance

- Last updated: 2026-02-17.
